<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.36.1" />
    <meta name="description" content="Secure deployment from the build pipeline into the cluster (XLATE)">
<meta name="author" content="Lutz Behnke">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>More Deployment Mojo :: hypathia.net</title>

    
    <link href="/css/nucleus.css?1530184884" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1530184884" rel="stylesheet">
    <link href="/css/hybrid.css?1530184884" rel="stylesheet">
    <link href="/css/featherlight.min.css?1530184884" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1530184884" rel="stylesheet">
    <link href="/css/auto-complete.css?1530184884" rel="stylesheet">
    <link href="/css/theme.css?1530184884" rel="stylesheet">
    <link href="/css/hugo-theme.css?1530184884" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1530184884"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/en/blog/secure-deployment-to-k8s.html">

        <a href="https://github.com/hypathianet/website">
          <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 9999"
                     src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
                     alt="Fork me on GitHub">
        </a>
            <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://hypathia.net">
<img width="100pt" src="/img/logo_large.png">
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1530184884"></script>
<script type="text/javascript" src="/js/auto-complete.js?1530184884"></script>
<script type="text/javascript">
    
        var baseurl = "\/en";
    
</script>
<script type="text/javascript" src="/js/search.js?1530184884"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/en/day_0.html" title="Day 0: Introduction" class="dd-item 
        
        
        
        ">
      <a href="/en/day_0.html">
          Day 0: Introduction
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/day_0/prerequisites.html" title="Prerequisites" class="dd-item ">
        <a href="/en/day_0/prerequisites.html">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_0/vision.html" title="Vision" class="dd-item ">
        <a href="/en/day_0/vision.html">
        Vision
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_0/architecture.html" title="Architecture" class="dd-item ">
        <a href="/en/day_0/architecture.html">
        Architecture
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_0/permissions.html" title="Permissions" class="dd-item ">
        <a href="/en/day_0/permissions.html">
        Permissions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_0/references.html" title="References" class="dd-item ">
        <a href="/en/day_0/references.html">
        References
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_0/help_needed.html" title="Help Needed" class="dd-item ">
        <a href="/en/day_0/help_needed.html">
        Help Needed
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_0/security_intro.html" title="" class="dd-item ">
        <a href="/en/day_0/security_intro.html">
        
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/day_1.html" title="Day 1: Installation and Setup" class="dd-item 
        
        
        
        ">
      <a href="/en/day_1.html">
          Day 1: Installation and Setup
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/day_1/networking.html" title="Introduction" class="dd-item ">
        <a href="/en/day_1/networking.html">
        Introduction
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_1/global_config.html" title="Global Configuration" class="dd-item ">
        <a href="/en/day_1/global_config.html">
        Global Configuration
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_1/certificate-authority.html" title="Certificate Authority" class="dd-item ">
        <a href="/en/day_1/certificate-authority.html">
        Certificate Authority
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_1/ipam.html" title="Internet Protocol Address Management (IPAM)" class="dd-item ">
        <a href="/en/day_1/ipam.html">
        Internet Protocol Address Management (IPAM)
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_1/image-management.html" title="Image Management" class="dd-item ">
        <a href="/en/day_1/image-management.html">
        Image Management
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/day_2.html" title="Day 2: Operations" class="dd-item 
        
        
        
        ">
      <a href="/en/day_2.html">
          Day 2: Operations
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/day_2/jupyter-hub.html" title="Jupyter Hub" class="dd-item ">
        <a href="/en/day_2/jupyter-hub.html">
        Jupyter Hub
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/day_2/service-mesh.html" title="Service Mesh (WIP)" class="dd-item ">
        <a href="/en/day_2/service-mesh.html">
        Service Mesh (WIP)
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/day_3.html" title="Day 3: Maintenance" class="dd-item 
        
        
        
        ">
      <a href="/en/day_3.html">
          Day 3: Maintenance
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/day_3/os_update.html" title="OS Update" class="dd-item ">
        <a href="/en/day_3/os_update.html">
        OS Update
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/userguide.html" title="User Guide" class="dd-item 
        
        
        
        ">
      <a href="/en/userguide.html">
          User Guide
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/faq.html" title="FAQ" class="dd-item 
        
        
        
        ">
      <a href="/en/faq.html">
          FAQ
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/knowledge_base.html" title="Knowledge Base" class="dd-item 
        
        
        
        ">
      <a href="/en/knowledge_base.html">
          Knowledge Base
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/knowledge_base/hyperkube-coreos-to-gcrio.html" title="CNI Plugin not found" class="dd-item ">
        <a href="/en/knowledge_base/hyperkube-coreos-to-gcrio.html">
        CNI Plugin not found
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/knowledge_base/multiple-identical-ingress.html" title="Ingress Name Collision" class="dd-item ">
        <a href="/en/knowledge_base/multiple-identical-ingress.html">
        Ingress Name Collision
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/blog.html" title="Blog" class="dd-item 
        parent
        
        
        ">
      <a href="/en/blog.html">
          Blog
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/blog/secure-deployment-to-k8s.html" title="More Deployment Mojo" class="dd-item active">
        <a href="/en/blog/secure-deployment-to-k8s.html">
        More Deployment Mojo
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fa fa-fw fa-language"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="/en/blog/secure-deployment-to-k8s.html" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="de" value="/de/blog/secure-deployment-to-k8s.html">Deutsch</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
       
      
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/en/'>Kubernetes Stack for Academia</a> > <a href='/en/blog.html'>Blog</a> > More Deployment Mojo
          
        
          
        
          
        
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#deploying-into-the-icc">Deploying into the ICC</a>
<ul>
<li><a href="#everything-insecure">Everything insecure?</a></li>
</ul></li>
<li><a href="#behind-the-scenes-more-admin-mojo">Behind the scenes: more admin-mojo</a></li>
<li><a href="#nachtrag">Nachtrag</a></li>
<li><a href="#colophon">Colophon</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>More Deployment Mojo</h1>
          

        




<h2 id="deploying-into-the-icc">Deploying into the ICC</h2>

<p>Let&rsquo;s assume the build pipeline of GitLab has finally succeeded and created a new container image. Naturally, now I want to have the pipeline deploy it into the cluster. Or to be more precise, to change the configuration of the cluster in such a manner, that it will pull the new image and then restart the ports according to the <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment">update rules</a> of Deployments and Replica Sets.</p>

<p>For this I have to set only a few variables in my <code>.gitlab-ci.yml</code> and a corresponding job must be present:</p>

<pre><code>variables:
  DOCKER_REGISTRY: &quot;docker-hub.informatik.haw-hamburg.de&quot;
  SERVICE_NAME: &quot;haw-world&quot;

deploy_image:
  environment:
    name: ICC-K8s
  stage: deploy
  image: nexus.informatik.haw-hamburg.de/kubectl:v1.10.2
  script:
  - sed &quot;s+$DOCKER_REGISTRY/$SERVICE_NAME+$DOCKER_REGISTRY/$SERVICE_NAME:$CI_PIPELINE_ID+g&quot; deploy.yaml &gt;deploy_new.yaml
  - kubectl apply -f deploy_new.yaml
</code></pre>

<p>More information can be found in the <code>userdoc</code> section <a href="https://userdoc.informatik.haw-hamburg.de/doku.php?id=docu:informatikcomputecloud#deployment_einer_applikation_aus_gitlab_in_die_icc">Deploying an application from GitLab to the ICC</a>.</p>

<h3 id="everything-insecure">Everything insecure?</h3>

<p>Can every user in every namespace in the ICC cluster make changes? No, only those users who have corresponding rights in the Gitlab for the corresponding groups or projects (* Owner *, * Master * to change, * Developer * to request information).</p>

<p>If I try to do the same things as in the CI script from my local machine, it will fail and I will point out that I am not authorized to make the change to the deployment.</p>

<p>Only when I authenticate against the cluster with the help of <code>kubelogin</code> will the change be accepted (for namespaces where I am at least * master *).</p>

<h2 id="behind-the-scenes-more-admin-mojo">Behind the scenes: more admin-mojo</h2>

<p>For the Gitlab-Runner to be able to make changes for all namespaces, a special integration between Gitlab and Kubernetes is necessary.</p>

<p>Luckily, Gitlab supports this integration. (Details in the <a href="https://docs.gitlab.com/ee/user/project/integrations/kubernetes.html">Gitlab Documentation</a>) and even expanding it continuously (see below). Unfortunately, GitLab makes the assumption that every user has the opportunity to create their own clusters at will, e.g. by launching virtual machines with cloud providers like AWS or GKE. In the HAW this is not possible. Therefore, the ICC uses a different model where all users work in their own namespaces in a shared cluster.</p>

<p>There is a service in the ICC called &lsquo;gl-k8s-integrator`. This ensures that there is the following for each namespace in the Kubernetes cluster:</p>

<ul>
<li>A <code>ServiceAccount</code> named<code>gitlab-serviceaccount</code> which is asserted with the role <code>gitlab-group-master</code>. This scooter allows you to read, delete, and modify all objects in a namespace, as well as create new objects in the namespace.</li>
<li>A <code>secret</code> containing a token.</li>
</ul>

<p>In addition, in every project at Gitlab, it incorporates the following into Kubernetes integration:</p>

<ul>
<li>The URL under which GitLab can reach the Kubernetes API.</li>
<li>The CA certificate for Gitlab to securely communicate with the Kubernetes API through TLS.</li>
<li>The namespace corresponding to the project.</li>
<li>The token from the <code>Secret</code> mentioned above.</li>
</ul>

<p>If the following fragment is found in a job of the CI / CD script:</p>

<pre><code>  environment:
    name: ICC-K8s
</code></pre>

<p>then GitLab sets automatically the correct settings, so that <code>kubectl</code> landed not only in the correct namespace, but also has the necessary rights to make changes there.</p>

<h2 id="nachtrag">Nachtrag</h2>

<p>As can be seen in Gitlab&rsquo;s documentation, the Kubernetes integration has been deprecated in its current form. We will adjust the current functionality in a timely manner with the current implementation of the Kubernetes connection. The ICC model to use an existing, shared cluster is already provided for by Gitlab&rsquo;s documentation (<a href="https://docs.gitlab.com/ee/user/project/clusters/index.html#adding-an-existing-">https://docs.gitlab.com/ee/user/project/clusters/index.html#adding-an-existing-</a> kubernetes-cluster).</p>

<h2 id="colophon">Colophon</h2>

<p>Photo by Ali Morshedlou on Unsplash</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/en/blog.html" title="Blog"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/en/day_0.html" title="Day 0: Introduction" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1530184884"></script>
    <script src="/js/perfect-scrollbar.min.js?1530184884"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1530184884"></script>
    <script src="/js/jquery.sticky.js?1530184884"></script>
    <script src="/js/featherlight.min.js?1530184884"></script>
    <script src="/js/html5shiv-printshiv.min.js?1530184884"></script>
    <script src="/js/highlight.pack.js?1530184884"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1530184884"></script>
    <script src="/js/learn.js?1530184884"></script>
    <script src="/js/hugo-learn.js?1530184884"></script>

    <link href="/mermaid/mermaid.css?1530184884" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1530184884"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

